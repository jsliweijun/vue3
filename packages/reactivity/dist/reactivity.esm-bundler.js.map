{"version":3,"file":"reactivity.esm-bundler.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["const Shared = {};\n\nexport default Shared;\n\nexport function isObject(val: Object) {\n    return typeof val === 'object' && val !== null;\n}\n\nexport const extend = Object.assign;\n","// 相应式 effect 三大特点：有标识，有类型标识，保留原来函数\n\nimport { TrackOpTypes } from './operators';\n\n/**\n * 创建一个相应式的effect ，作用是 当数据变化时，这个effect能再执行\n * @param fn\n * @param options\n */\nexport function effect(fn: Function, options: any = {}) {\n    // 这里做数据格式化，创建 effect 用另外一个函数\n    const effect = createReactiveEffect(fn, options);\n\n    // 根据参数作用后面的操作\n    if (!options.lazy) {\n        // 默认 effect 会执行\n        effect();\n    }\n\n    return effect;\n}\n\nlet uid = 0;\nlet activeEffect: any; // 保存当前执行的 effect ，做中间变量，让两个函数能共享它\nlet effectStack: any = [];\nfunction createReactiveEffect(fn: Function, options: any) {\n    const effect = function reactiveEffect() {\n        // 一次渲染时，判断是否已添加了effect ，避免循环收集\n        if (!effectStack.includes(effect)) {\n            try {\n                effectStack.push(effect);\n                activeEffect = effect;\n                return fn(); // 传入的cb，这函数里面调用 get方法，会之前 baseHandlers 中的get 方法\n            } finally {\n                effectStack.pop();\n                activeEffect = effectStack[effectStack.length - 1];\n            }\n        }\n    };\n\n    // 相应式 effect 三大特点：有标识，有类型标识，保留原来函数\n    effect.id = uid;\n    effect._isEffect = true;\n    effect.raw = fn;\n    effect.options = options;\n\n    return effect;\n}\n\n/**\n * 收集依赖，数据对应的 effect ，收集 effect ，使用栈结构，保证对应上\n * 让属性收集对应的 effect\n * effect 对应 watcher\n */\nconst targetMap = new WeakMap();\nexport function track(target: object, type: TrackOpTypes, key: string) {\n    console.log(target, key, activeEffect);\n    // 映射关系 , weakMap\n    // {\n    //     target: {\n    //         key:activeEffect;\n    //     }\n    // }\n\n    if (activeEffect === undefined) {\n        return;\n    }\n\n    let depsMap = targetMap.get(target);\n    if (!depsMap) {\n        targetMap.set(target, (depsMap = new Map()));\n    }\n    let dep = depsMap.get(key);\n    if (!dep) {\n        depsMap.set(key, (dep = new Set()));\n    }\n    if (!dep.has(activeEffect)) {\n        dep.add(activeEffect);\n    }\n\n    console.log(targetMap);\n}\n\n// 问题场景\n// effect(()=>{\n//     state.xxx++ // 数据一变，回调执行，这样会进行会无限循环，依赖不需要收集多次\n// })\n","// 创建 4 个 Proxy 到配置对象 new Proxy(target,handler)\n\nimport { extend, isObject } from '@vue/shared';\nimport { track } from './effect';\nimport { TrackOpTypes } from './operators';\nimport { reactive, readonly } from './reactive';\n\n//是不是仅读， 没有set 方法\n// 是不是深度，\n\n/**\n *\n * @param isReadonly\n * @param shallow\n * @returns\n */\nfunction createGetter(isReadonly = false, shallow = false) {\n    return function get(target: object, key: string, receiver: object) {\n        const res = Reflect.get(target, key, receiver); // target[key]\n\n        // 收集依赖\n        if (!isReadonly) {\n            // 收集依赖，数据更新后更新视图,收集属性对应的 effect\n            track(target, TrackOpTypes.GET, key);\n        }\n\n        if (shallow) {\n            return res;\n        }\n\n        // 返回值是否为对象，要进行深层代理, 这是懒代理。\n        if (isObject(res)) {\n            return isReadonly ? readonly(res) : reactive(res);\n        }\n\n        return res;\n    };\n}\n\nconst get = createGetter();\nconst shollowGet = createGetter(false, true);\nconst readonlyGet = createGetter(true);\nconst showllowReadonlyGet = createGetter(true, true);\n\nfunction createSetter(shallow = false) {}\n\nconst set = createSetter();\nconst shallowSet = createSetter(true);\n\nexport const mutableHandlers = { get };\nexport const shallowReactiveHandlers = { get: shollowGet };\n\nlet readonlyObj = {\n    set: (target: object, key: string) => {\n        console.warn(`set on key ${key}  failed`);\n    }\n};\n\nexport const readonlyHandlers = extend(\n    {\n        get: readonlyGet\n    },\n    readonlyObj\n);\nexport const shallowReaconlyHandlers = extend({ get: showllowReadonlyGet }, readonlyObj);\n","// 对外提供四个 核心 API ， 对传入的对象实现相应式\n// 是不是仅读，是不是深度， 克里化，通过参数判断。 统一实现响应式方法\n// new Proxy(target,handler)\n\nimport { mutableHandlers, shallowReaconlyHandlers, shallowReactiveHandlers, readonlyHandlers } from './baseHandlers';\n\nimport { isObject } from '@vue/shared';\n\n// 将代理配置对象封装到另外一个文件\n\nexport function reactive(target: any) {\n    return createReactiveObject(target, false, mutableHandlers);\n}\nexport function shallowReactive(target: any) {\n    return createReactiveObject(target, false, shallowReactiveHandlers);\n}\nexport function readonly(target: any) {\n    return createReactiveObject(target, true, readonlyHandlers);\n}\nexport function shallowReadonly(target: any) {\n    return createReactiveObject(target, true, shallowReaconlyHandlers);\n}\n\nconst reactiveMap = new WeakMap();\nconst readonlyMap = new WeakMap();\n\n/**\n *\n * @param target 目标对象\n * @param isReadonly  是否只读\n * @param baseHandlers Proxy 的配置对象 get/set\n */\nexport function createReactiveObject(target: Object, isReadonly: Boolean, baseHandlers: Object) {\n    // target 只能是对象\n    if (!isObject(target)) {\n        return target;\n    }\n\n    // 记录对象是否被代理过,代理过就不被代理\n    const proxyMap = isReadonly ? readonlyMap : reactiveMap;\n\n    const existProxy = proxyMap.get(target);\n    if (existProxy) {\n        return existProxy;\n    }\n\n    // 创建代理对象，并记录\n    const p = new Proxy(target, baseHandlers);\n    proxyMap.set(target, p);\n\n    return p;\n}\n"],"names":[],"mappings":"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"}